# I04@V01 Design: Production Polish

> **Goal**: Complete production release polish by addressing the 3 minor issues identified in v01-checklist

**Date**: 2026-02-06
**Status**: 设计阶段
**Scope**: v01-checklist L-1, L-2, L-3

---

## Overview

**Current State**: Can go to production ✅
- 407 tests passing
- Core functionality verified
- No blocking bugs

**Goal**: Polish remaining minor issues for a clean release

---

## Issues to Resolve

| ID | Issue | Location | Severity | Effort |
|----|-------|----------|----------|--------|
| L-1 | Import sorting | `__init__.py:8` | Low | 5 min |
| L-2 | Missing PyYAML stubs | `result_extractor.py:125` | Low | 5 min |
| L-3 | Incomplete type annotations | 9 functions | Medium | 2-3 hours |

---

## Solution Design

### L-1: Fix Import Sorting

**Problem**: Import block in `__init__.py` is unsorted

**Solution**:
```bash
ruff format routilux/__init__.py
```

### L-2: Add PyYAML Type Stubs

**Problem**: mypy reports "Library stubs not installed for yaml"

**Solution**: Add `types-PyYAML` to dev dependencies in `pyproject.toml`

```toml
[dependency-groups]
dev = [
    # ... existing ...
    "types-PyYAML>=6.0.0",
]
```

### L-3: Enable Strict Type Checking

**Problem**: 9 functions in mixin classes lack return type annotations

**Files requiring changes**:
1. `routilux/analysis/analyzers/routine.py:32` - `__init__()`
2. `routilux/routine_mixins.py:51` - `ConfigMixin.__init__()`
3. `routilux/routine_mixins.py:140` - `ExecutionMixin.__init__()`
4. `routilux/routine_mixins.py:141` - `ExecutionMixin.__init__()`
5. `routilux/routine_mixins.py:363` - `LifecycleMixin.__init__()`
6. `routilux/routine_mixins.py:364` - `LifecycleMixin.__init__()`
7. `routilux/routine.py:136` - `Routine.__init__()`
8. `routilux/routine.py:140` - `Routine.__init__()`
9. `routilux/builtin_routines/text_processing/result_extractor.py:109` - `_register_builtin_extractors()`

**Solution**:

1. Update `pyproject.toml`:
```toml
[tool.mypy]
disallow_untyped_defs = true   # Change from false
check_untyped_defs = true      # Add
```

2. Add `-> None` return type to all `__init__` methods and `_register_builtin_extractors()`

---

## Implementation Plan

### Task 1: Fix Import Sorting (L-1)
- Run `ruff format` on `__init__.py`
- Verify with `ruff check`

### Task 2: Add PyYAML Type Stubs (L-2)
- Edit `pyproject.toml` to add `types-PyYAML`
- Run `uv sync` to install
- Verify with `mypy`

### Task 3: Add Return Type Annotations (L-3)
- Add `-> None` to 8 `__init__` methods
- Add `-> None` to `_register_builtin_extractors()`
- Enable `disallow_untyped_defs = true`
- Verify all tests pass
- Verify mypy passes

### Task 4: Final Verification
- Run full test suite
- Run mypy strict mode
- Run ruff linting
- Create summary document

---

## Success Criteria

- [ ] All 407 tests pass
- [ ] `mypy routilux/` passes with no errors
- [ ] `ruff check routilux/` passes with no errors
- [ ] Import sorting fixed
- [ ] PyYAML stubs installed
- [ ] All functions have return type annotations

---

## Verification Commands

```bash
# Tests
uv run pytest tests/ -v

# Type checking
uv run mypy routilux/

# Linting
uv run ruff check routilux/
```
